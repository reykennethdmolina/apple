{% extends 'base-form.html' %}
{% load staticfiles %}
{% load humanize %}
{% block page-title %} Operational Fund Request {% endblock page-title %}
{% block page-content %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/select2/css/select2.css' %}" />
    <link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'financial-layout/assets/plugin/bootstrap-wysihtml5-0.0.2/bootstrap-wysihtml5-0.0.2.css' %}" />
    <style>
        .select2-results__option {
            font-size: 12px;
        }
        .form-control.input-sm.date-yyyymmdd.datepicker.week {
            background-color: transparent;
        }
        .input-search {
            z-index: 99;
        }
        /*.extra-fields{
             display: none;
        }*/
        .rotate-up {
            -webkit-transform: rotate(180deg);
            -webkit-transition: -webkit-transform .5s;
        }
        .rotate-down {
            -webkit-transform: rotate(0deg);
            -webkit-transition: -webkit-transform .5s;
        }
        .rotate-icon{
            display: inline-block;
        }
        .item_hidden{
            display: none;
        }
        .select2-container--default .select2-results__option[aria-disabled=true] {
            display: none;
        }
        .disabled-white{
            background-color: white !important;
        }
        .badge{
            margin-top: 3px;
            color: transparent;
            text-shadow: none;
            padding: 3px 5px 3px;
        }
    </style>
{% endblock extra_css %}
<div class="panel">
    <div class="panel-body container-fluid">
        <div class="row">
            <div class="margin-bottom-20">
                <div class="panel-heading" style="padding-top: 10px; padding-bottom: 20px; padding-right: 25px;">
                    <h3 class="panel-title" style="display: inline;">UPDATE</h3>
                    {% if perms.operationalfund.delete_ofmain and object.ofstatus == 'F' and object.isdeleted == 0 and object.status == 'A' %}
                    <a href="{% url 'operationalfund:delete' object.id %}" class="floatright">
                        <button type="button" id="delete" class="btn btn-round btn-info btn-sm waves-effect
                        waves-light get_report">
                            <i class="icon fa-trash" aria-hidden="true"></i>&nbsp; Cancel
                        </button>
                    </a>
                    {% endif %}
                    <a href="{% url 'operationalfund:userpdf' object.id %}" target="_blank" class="floatright">
                        <button type="button" id="get_pdf" class="btn btn-round btn-info btn-sm waves-effect
                        waves-light get_report">
                            <i class="icon fa-file-pdf-o" aria-hidden="true"></i>&nbsp; Print
                        </button>
                    </a>
                    <a href="{% url 'operationalfund:detail' object.id %}" class="floatright">
                        <button type="button" id="get_details" class="btn btn-round btn-info btn-sm waves-effect
                        waves-light get_report">
                            <i class="icon fa-info-circle" aria-hidden="true"></i>&nbsp; View
                        </button>
                    </a>
                </div>
                <div class="row col-md-12 row-lg margin-left-10 margin-bottom-20">
                    <div class="form-group col-sm-6">
                        <label class="control-label col-sm-4">Current&nbsp;Status:</label>
                        <label id="currentstatus" class="control-label col-sm-8
                            {% if ofstatus == 'Approved' or ofstatus == 'Released' %} text-success
                            {% elif ofstatus == 'Disapproved' %} text-danger
                            {% elif ofstatus == 'For Approval' or ofstatus == 'In Process' %} text-info
                            {% endif %}">{{ ofstatus }}</label>
                    {% if assignedcashier %}
                        <label class="control-label col-sm-4">Assigned&nbsp;Cashier:</label>
                        <label class="control-label col-sm-8">{{ assignedcashier }}</label>
                    {% endif %}
                    {% if approverresponse %}
                        <label class="control-label col-sm-4">
                            {% if approverresponse == 'A' %}Approved
                            {% elif approverresponse == 'D' %}Disapproved
                            {% endif %}&nbsp;By:</label>
                        <label class="control-label col-sm-8">{{ actualapprover }}</label>
                    {% endif %}
                    {% if releasedate %}
                        <label class="control-label col-sm-4">Released&nbsp;To:</label>
                        <label class="control-label col-sm-8">{{ releasedto }}</label>
                    {% endif %}
                    </div>
                    <div class="form-group col-sm-6">
                        <label class="control-label col-sm-12">&nbsp;</label>
                    {% if assignedcashier %}
                        <label class="control-label col-sm-12">&nbsp;</label>
                    {% endif %}
                    {% if approverresponse %}
                        <label class="control-label col-sm-4">
                            {% if approverresponse == 'A' %}Approved
                            {% elif approverresponse == 'D' %}Disapproved
                            {% endif %}&nbsp;On:</label>
                        <label class="control-label col-sm-8">{{ responsedate|date:'F j, Y' }}</label>
                    {% endif %}
                    {% if releasedate %}
                        <label class="control-label col-sm-4">Released&nbsp;On:</label>
                        <label class="control-label col-sm-8">{{ releasedate|date:'F j, Y' }}</label>
                    {% endif %}
                    </div>
                </div>
                <form method="post" id="form-b">
                    {% csrf_token %}
                    <input type="hidden" name="secretkey" id="secretkey" value="{{ secretkey }}"/>
                    <div class="row col-md-12 row-lg margin-left-10">
                        <div class="row col-md-8 row-lg margin-left-10">
                            <div class="form-group col-sm-3 margin-bottom-0">
                                <label class="control-label" for="id_ofnum">Number</label>
                                <input type="text" class="form-control input-sm" id="id_ofnum" value="OF-{{ savedoftype }}-{{ ofnum }}" readonly="readonly">
                                <span class="help-block form-error">{{ form.ofnum.errors.as_text }}</span>
                            </div>
                            <div class="form-group col-sm-3 margin-bottom-0">
                                <label class="control-label" for="id_ofdate">OF Date</label>
                                <input type="text" class="form-control input-sm date-yyyymmdd disabled-white" readonly="readonly" style="padding: 5px 10px" id="id_ofdate" name="ofdate" placeholder="YYYY-MM-DD" data-validation="required" value="{% if form.ofdate.value %}{{ form.ofdate.value|date:'Y-m-d' }}{% else %}{% now "Y-m-d" %}{% endif %}">
                                <span class="help-block form-error">{{ form.ofdate.errors.as_text }}</span>
                            </div>
                            <div class="form-group col-sm-6 {{ form.oftype.errors|yesno:'has-error,' }} margin-bottom-0">
                                <label class="control-label" for="id_oftype">OF Type</label>
                                <select class="form-control input-sm select2" data-validation="required" id="id_oftype" name="oftype">
                                    {% for data in oftype %}
                                        <option value="{{ data.id }}" {% if form.oftype.value|add:0 == data.id %} selected="selected" {% endif %}>{{ data.code }} - {{ data.description }}</option>
                                    {% endfor %}
                                </select>
                                </select>
                                <span class="help-block form-error">{{ form.designatedapprover.errors.as_text }}</span>
                            </div>
                            <div class="form-group col-sm-12"></div>
                            <div class="form-group col-sm-6 {{ form.requestor.errors|yesno:'has-error,' }}">
                                <label class="control-label" for="id_requestor">Requestor</label>
                                <select class="form-control input-sm select2" data-validation="required" id="id_requestor" name="requestor">
                                    <option value="">-- Select --</option>
                                    {% for data in requestor %}
                                        <option value="{{ data.id }}" data-amount={{ data.cellphone_subsidize_amount }}
                                                {% if form.requestor.value != None %}
                                                    {% if form.requestor.value|add:0 == data.id %}selected="selected"{% endif %}
                                                {% else %}
                                                    {% if user_employee.id|add:0 == data.id %}selected="selected"{% endif %}
                                                {% endif %}>
                                            {{ data.firstname }} {{ data.lastname }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <span class="help-block form-error">{{ form.requestor.errors.as_text }}</span>
                            </div>
                            <div class="form-group col-sm-6 {{ form.designatedapprover.errors|yesno:'has-error,' }}">
                                <label class="control-label" for="id_designatedapprover">Designated Approver</label>
                                <select class="form-control input-sm select2" data-validation="required" id="id_designatedapprover" name="designatedapprover">
                                    <option value="">-- Select --</option>
                                    {% for designatedapprover in designatedapprover %}
                                        <option value="{{ designatedapprover.id }}" {% if form.designatedapprover.value|add:0 == designatedapprover.id %} selected="selected" {% endif %}>{{ designatedapprover.firstname }} {{ designatedapprover.lastname }}</option>
                                    {% endfor %}
                                </select>
                                <span class="help-block form-error">{{ form.designatedapprover.errors.as_text }}</span>
                            </div>
                            <div class="form-group col-sm-6 {{ form.department.errors|yesno:'has-error,' }}">
                                <label class="control-label" for="id_department">Department</label>
                                <select class="form-control input-sm select2" data-validation="required" id="id_department" name="department">
                                    <option value="">-- Select --</option>
                                    {% for department in department %}
                                        <option value="{{ department.id }}" {% if form.department.value|add:0 == department.id %} selected="selected" {% endif %}>{{ department.code }} | {{ department.departmentname }}</option>
                                    {% endfor %}
                                </select>
                                <span class="help-block form-error">{{ form.employee.errors.as_text }}</span>
                            </div>
                        </div>
                        <div class="form-group col-sm-4 margin-bottom-0">
                            <div class="panel">
                                <br>
                                <label class="control-label pull-right" style="margin-right: 20px">Total Amount:</label><br><br>
                                <div class="pull-right" id="totalamount" style="margin-right: 20px">{{ amount|floatformat:2|intcomma }}</div><br><br>
                            </div>
                            <button type="submit" class="btn btn-round btn-success floatright" id="validateButton">Submit</button>
                        </div>
                    </div>
                    <div class="row row-lg margin-left-10">
                    </div>
                    <div class="row row-lg margin-left-10">
                    </div>
                    </form>
                </div>
                <div class="col-sm-12">
                    <div class="panel">
                        <div class="panel-body">
                            <h4>
                                Request Details
                                <div class="pull-right">

                                    <small>For Approval&nbsp;&nbsp;</small> <span class="badge badge-radius badge-default">1</span>
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    <small>Approved&nbsp;&nbsp;</small> <span class="badge badge-radius badge-success">1</span>
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    <small>Disapproved&nbsp;&nbsp;</small> <span class="badge badge-radius badge-danger">1</span>
                                </div>
                            </h4>

                            <br>
                            <table class="table item_table">
                                <thead>
                                <tr>
                                    <th>
                                        <div class="form-group col-sm-1 margin-bottom-0"></div>
                                        <div class="form-group col-sm-3 margin-bottom-0">OF Subtype</div>
                                        <div class="form-group col-sm-4 margin-bottom-0">Payee</div>
                                        <div class="form-group col-sm-3 margin-bottom-0">Amount</div>
                                        <div class="form-group col-sm-1 margin-bottom-0" style="text-align:right">
                                            <a href="#_" id="item_add" style="font-size: 17px" class="pull-right">
                                                <i class="icon fa-plus-square" aria-hidden="true"></i>
                                            </a>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                    {% for itemtemp in itemtemp %}
                                        <tr>
                                            <td>
                                                <div class="form-group col-sm-1 margin-bottom-0 item_counter">{{ itemtemp.item_counter }}</div>
                                                <div class="form-group col-sm-3 margin-bottom-0">
                                                    <select class="form-control input-sm item_input_ofsubtype" style="width: 100%;"></select>
                                                </div>
                                                <div class="form-group col-sm-4 margin-bottom-0">
                                                    <div class="input-search">
                                                        <input type="text" data-validation="required" class="form-control input-sm input-payee" name="payee" style="text-transform:uppercase; background: white;"
                                                            data-currency="1" data-fxrate="1.00" value="{{ itemtemp.payee_name }}">
                                                        <button type="button" class="input-search-button" data-toggle='modal' data-target='#lookupModal'>
                                                            <i class="icon fa-ellipsis-h" aria-hidden="true"></i>
                                                        </button>
                                                    </div>
                                                    <input type="hidden" class="form-control input-sm input-hiddenpayee" name="hiddenpayee" value="{% if itemtemp.payee %}{{ itemtemp.payee_name }}{% endif %}">
                                                    <input type="hidden" class="form-control input-sm input-hiddenpayeeid" name="hiddenpayeeid" value="{{ itemtemp.payee|default:'' }}">
                                                </div>
                                                <div class="form-group col-sm-2 margin-bottom-0">
                                                    <input type="text" class="form-control disabled-white input-sm amount text-right input-amount" placeholder="0.00" value="{{ itemtemp.amount|floatformat:2|intcomma }}">
                                                </div>
                                                <div class="form-group col-sm-2 margin-bottom-0">
                                                    <div class="rotate-icon rotate-up">
                                                        <a href="#_" style="font-size: 25px;vertical-align: top;" class="expand-fields"><i class="icon fa-sort-down" aria-hidden="true"></i></a>
                                                    </div>
                                                    <a href="#_" style="font-size: 17px" class="pull-right item_delete"><i class="icon fa-trash" aria-hidden="true"></i></a>
                                                    <div class="pull-right">&nbsp;&nbsp;&nbsp;</div>
                                                    <a href="#_" style="font-size: 17px" class="pull-right item_save" data-itemid="{{ itemtemp.id }}"><i class="icon fa-save" aria-hidden="true"></i></a>
                                                    <div class="pull-right">&nbsp;&nbsp;&nbsp;</div>
                                                    <span class="pull-right badge badge-radius badge-{% if itemtemp.ofitemstatus == 'F' %}default{% elif itemtemp.ofitemstatus == 'A' %}success{% else %}danger{% endif %}">1</span>
                                                </div>
                                                <div class="extra-fields row col-sm-12">
                                                    <div class="form-group col-sm-1"></div>
                                                    <div class="form-group col-sm-10" style="height: 1px;"><hr></div>
                                                    <div class="form-group col-sm-1"></div>
                                                    <div class="form-group col-sm-12"></div>
                                                    <div class="form-group col-sm-10 col-sm-offset-1">
                                                        <label class="control-label"><small>Particulars</small></label>
                                                        <textarea rows="2" class="form-control text-particulars disabled-white input-sm">{{ itemtemp.particulars }}</textarea>
                                                    </div>
                                                    <div class="form-group col-sm-10 col-sm-offset-1 padding-left-0">
                                                        <div class="form-group col-sm-4" style="display: none">
                                                            <label class="control-label"><small>Currency</small></label>
                                                            <select class="form-control input-sm select-currency" name="currency">
                                                                {% for data in currency %}
                                                                    <option value="{{ data.id }}" data-rate="{{ data.fxrate|floatformat:2 }}" {% if itemtemp.currency == data.id %}selected="selected"{% endif %}>[{{ data.symbol }}]&nbsp;&nbsp;&nbsp;{{ data.description }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-group col-sm-2" style="display: none">
                                                            <label class="control-label"><small>FX Rate</small></label>
                                                            <input type="text" class="form-control input-sm input-fxrate" value="{{ itemtemp.fxrate }}">
                                                        </div>
                                                        <div class="form-group col-sm-3">
                                                            <label class="control-label"><small>Period From</small></label>
                                                            <input type="text" class="form-control input-sm datepickerfrom_month datepicker-periodfrom disabled-white" readonly="readonly" value="{{ itemtemp.periodfrom|date:'Y-m-d'|default:'' }}">
                                                        </div>
                                                        <div class="form-group col-sm-3">
                                                            <label class="control-label"><small>Period To</small></label>
                                                            <input type="text" class="form-control input-sm datepickerto_month datepicker-periodto disabled-white" readonly="readonly" value="{{ itemtemp.periodto|date:'Y-m-d'|default:'' }}">
                                                        </div>
                                                    </div>
                                                    <div class="form-group col-sm-10 col-sm-offset-1 padding-left-0">
                                                        <div class="form-group col-sm-3">
                                                            <label class="control-label"><small>No. of Pax</small></label>
                                                            <input type="number" class="form-control input-sm disabled-white no_of_pax" value="{{ itemtemp.noofpax }}">
                                                        </div>
                                                        <div class="form-group col-sm-9 margin-top-30">
                                                            <code class="budget_warning" style="display: none">*The amount exceeds the {{ mealbudget }}-peso limit per pax. This shall be subject for review.</code>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr class="warning">
                                        <td>
                                            <div class="form-group col-sm-1 margin-bottom-0 item_counter">1</div>
                                            <div class="form-group col-sm-3 margin-bottom-0">
                                                <select class="form-control input-sm item_input_ofsubtype" style="width: 100%;"></select>
                                            </div>
                                            <div class="form-group col-sm-4 margin-bottom-0">
                                                <div class="input-search">
                                                    <input type="text" data-validation="required" class="form-control input-sm input-payee" name="payee" style="text-transform:uppercase; background: white;"
                                                        data-currency="1" data-fxrate="1.00">
                                                    <button type="button" class="input-search-button" data-toggle='modal' data-target='#lookupModal'>
                                                        <i class="icon fa-ellipsis-h" aria-hidden="true"></i>
                                                    </button>
                                                </div>
                                                <input type="hidden" class="form-control input-sm input-hiddenpayee" name="hiddenpayee">
                                                <input type="hidden" class="form-control input-sm input-hiddenpayeeid" name="hiddenpayeeid">
                                            </div>
                                            <div class="form-group col-sm-2 margin-bottom-0">
                                                <input type="text" class="form-control input-sm amount text-right input-amount" placeholder="0.00">
                                            </div>
                                            <div class="form-group col-sm-2 margin-bottom-0">
                                                <div class="rotate-icon rotate-up">
                                                    <a href="#_" style="font-size: 25px;vertical-align: top;" class="expand-fields"><i class="icon fa-sort-down" aria-hidden="true"></i></a>
                                                </div>
                                                <a href="#_" style="font-size: 17px" class="pull-right item_delete"><i class="icon fa-trash" aria-hidden="true"></i></a>
                                                <div class="pull-right">&nbsp;&nbsp;&nbsp;</div>
                                                <a href="#_" style="font-size: 17px" class="pull-right item_save" data-itemid=""><i class="icon fa-save" aria-hidden="true"></i></a>
                                                <div class="pull-right">&nbsp;&nbsp;&nbsp;</div>
                                                <span class="pull-right badge badge-radius badge-default">1</span>
                                            </div>
                                            <div class="extra-fields row col-sm-12">
                                                <div class="form-group col-sm-1"></div>
                                                <div class="form-group col-sm-10" style="height: 1px;"><hr></div>
                                                <div class="form-group col-sm-1"></div>
                                                <div class="form-group col-sm-12"></div>
                                                <div class="form-group col-sm-10 col-sm-offset-1">
                                                    <label class="control-label"><small>Particulars</small></label>
                                                    <textarea rows="2" class="form-control text-particulars input-sm"></textarea>
                                                </div>
                                                <div class="form-group col-sm-10 col-sm-offset-1 padding-left-0">
                                                    <div class="form-group col-sm-4" style="display: none">
                                                        <label class="control-label"><small>Currency</small></label>
                                                        <select class="form-control input-sm select-currency" name="currency">
                                                            {% for data in currency %}
                                                                <option value="{{ data.id }}" data-rate="{{ data.fxrate|floatformat:2 }}">[{{ data.symbol }}]&nbsp;&nbsp;&nbsp;{{ data.description }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="form-group col-sm-2" style="display: none">
                                                        <label class="control-label"><small>FX Rate</small></label>
                                                        <input type="text" class="form-control input-sm input-fxrate" value="1.00">
                                                    </div>
                                                    <div class="form-group col-sm-3">
                                                        <label class="control-label"><small>Period From</small></label>
                                                        <input type="text" class="form-control input-sm datepickerfrom_month datepicker-periodfrom disabled-white" readonly="readonly">
                                                    </div>
                                                    <div class="form-group col-sm-3">
                                                        <label class="control-label"><small>Period To</small></label>
                                                        <input type="text" class="form-control input-sm datepickerto_month datepicker-periodto disabled-white" readonly="readonly">
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-10 col-sm-offset-1 padding-left-0">
                                                    <div class="form-group col-sm-3">
                                                        <label class="control-label"><small>No. of Pax</small></label>
                                                        <input type="number" class="form-control input-sm no_of_pax">
                                                    </div>
                                                    <div class="form-group col-sm-9 margin-top-30">
                                                        <code class="budget_warning" style="display: none">*The amount exceeds the {{ mealbudget }}-peso limit per pax. This shall be subject for review.</code>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <div class="clearfix"></div>
            <div id="lookupModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Payee Lookup</h4>
                        </div>
                        <div class="modal-body" style="overflow:hidden;">
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <select class="form-control input-sm ajaxselect2 col-sm-12" style="width: 565px;"
                                            id="id_payeelookup" name="payeelookup">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info" id="payeeconfirm" disabled="disabled">Confirm</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="item-add-error" class="custom-alert danger">Complete unsaved item first.</div>
<div id="item-save-error" class="custom-alert danger">Complete item details first.</div>
<div id="item-save-success" class="custom-alert success">Item successfully saved.</div>
<div id="item-delete-success" class="custom-alert success">Item successfully deleted.</div>
<div id="of-save-error" class="custom-alert danger">Operational fund should at least have one item.</div>
<div id="of-save-amount-error" class="custom-alert danger">Petty Cash Amount should not exceed to 1000.00</div>
<div id="of-save-amount-error2" class="custom-alert danger">Cellphone subsidy amount limit exceeded.</div>
<div id="oftype-change-error" class="custom-alert danger">Clear all items first.</div>
{% endblock page-content %}
{% block extra_js %}
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/custom-datepicker.js' %}"></script>
    <script src="{% static 'js/jquery.validate.js' %}" type="text/javascript"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-wysihtml5-0.0.2/libs/js/wysihtml5-0.3.0_rc2.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-wysihtml5-0.0.2/bootstrap-wysihtml5-0.0.2.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/select2/js/select2.min.js' %}"></script>
    <script src="{% static 'js/jquery.maskMoney.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom-maskMoney.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/ajaxselect2.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
        $('.select2').select2({});
        ajaxselect2("supplier_payee");

        var lastof = '';
        var payeeIndex = 0;

        //ofsubtype list
        ofsubtype_list = "<option value=''>-- Select --</option>";
        {% for data in ofsubtype %}
            ofsubtype_list += "<option value='{{ data.id }}' data-oftype='{{ data.oftype.id }}'>{{ data.code }} - {{ data.description }}</option>";
        {% endfor %}

        $(document).ready(function() {
            if($("#id_oftype option:selected").text().indexOf("Cellphone Subsidy") >= 0){
                $("#id_requestor option[data-amount='0.00']").attr('disabled','disabled');
                $("#id_requestor").select2();
            }

            /** Prepare hidden field **/
            $('.item_table tbody tr.warning').last().clone().prependTo('.item_table tbody');
            $('.item_table tbody tr.warning').last().addClass('item_hidden');
            $('.item_table tbody tr.warning').first().remove();
            collapseFields();
            initMaskMoney('amount');

            /** Init ofsubtype **/
            $('.item_table tbody tr').find('.item_input_ofsubtype').html(ofsubtype_list);
            $('.item_input_ofsubtype:not(:last)').select2();
            $('.item_input_ofsubtype').find('option').prop( "disabled", true );
            $('.item_input_ofsubtype').find('option[data-oftype=' + $('#id_oftype').val() + ']').prop( "disabled", false );
            initializeDateRange();

            var i = 0;
            {% for itemtemp in itemtemp %}
                $('.item_input_ofsubtype:eq('+i+')').select2("destroy").select2().val('{{ itemtemp.ofsubtype.id }}').trigger('change.select2');
                i++;
            {% endfor %}


            if ($('#id_oftype option:selected').text().toLowerCase().indexOf("cellphone subsidy") >= 0){
                $('.datepicker-periodfrom').parent().show();
                $('.datepicker-periodto').parent().show();
            }
            else {
                $('.datepicker-periodfrom').parent().hide();
                $('.datepicker-periodto').parent().hide();
            }

            $('.item_input_ofsubtype').each(function (){
                if($(this).val() == {{ mealexpense }}){
                    $(this).parent().parent().find('.no_of_pax').parent().parent().show();
                }
                else {
                    $(this).parent().parent().find('.no_of_pax').parent().parent().hide();
                }
            });

            /** Disable fields if status != 'For Approval' and status != 'Disapproved' **/
            if($('#currentstatus').text() != 'For Approval' && $('#currentstatus').text() != 'Disapproved'){
                $("#id_ofdate").prop("readonly", true).datepicker("destroy").removeClass("datepicker").removeAttr('id');
                $("#id_oftype option:selected").siblings().attr('disabled','disabled');
                $("#id_requestor option:selected").siblings().attr('disabled','disabled');
                $("#id_designatedapprover option:selected").siblings().attr('disabled','disabled');

                $(".item_input_ofsubtype option:selected").siblings().attr('disabled','disabled');
                $(".input-payee").prop("readonly", true);
                $(".input-search-button").hide();
                $(".input-amount").prop("readonly", true);
                $(".text-particulars").prop("readonly", true);
                $(".datepicker-periodfrom").prop("readonly", true).datepicker("destroy").removeClass("datepicker").removeAttr('id');
                $(".datepicker-periodto").prop("readonly", true).datepicker("destroy").removeClass("datepicker").removeAttr('id');
                $(".no_of_pax").prop("readonly", true);
                $("#item_add").hide();
                $(".item_save").hide();
                $(".item_delete").hide();

                $("#validateButton").hide();
            }

            $('.no_of_pax').each(function() {
                if($(this).val() != '' && $(this).val() != '0' && $(this).is(":visible") &&
                    $(this).parent().parent().parent().parent().find('.input-amount').val() != '0.00' &&
                    $(this).parent().parent().parent().parent().find('.input-amount').val() != ''){
                    var no_of_pax = parseFloat($(this).val());
                    var budget_spent = parseFloat($(this).parent().parent().parent().parent().find('.input-amount').val().replace(',',''));
                    var budget_limit = parseFloat({{ mealbudget }});
                    if(showBudgetWarning(no_of_pax, budget_spent, budget_limit)){
                        $(this).parent().parent().find('.budget_warning').show();
                    }
                    else {
                        $(this).parent().parent().find('.budget_warning').hide();
                    }
                }
            });

            /** Onchange oftype **/
            $(document).on('click', '.select2', function(e) {
                lastof = $('#id_oftype option:selected').val();
            });
            $(document).on('change', '#id_oftype', function(e){
                if($('.item_table tbody tr').length == $('.item_table tbody tr.warning').length) {
                    assignSubtypeOption(1);
                }
                else{
                    customAlert($('#oftype-change-error'));
                    $('#id_oftype').val(lastof).trigger('change.select2');
                }
            });

            /** Onclick input-search-button **/
            $(document).on('click', '.input-search-button', function(){
                payeeIndex = $(this).index('.input-search-button');
            });

            /** Onchange Payee Lookup **/
            $('#id_payeelookup').on("change", function(e) {
                $('#payeeconfirm').prop('disabled', false);
            });

            /** Onclick Payee Confirm **/
            $('#payeeconfirm').click(function(){
                if($('#id_payeelookup').val() == null){
                    console.log("test");
                    alert("Please select a payee first.");
                }
                else {
                    var content = $('#id_payeelookup option:selected').text().replace(/(<([^>]+)>)/ig,"").toUpperCase();
                    $('.input-payee:eq(' + payeeIndex + ')').val(content);
                    $('.input-hiddenpayee:eq(' + payeeIndex + ')').val(content);
                    $('.input-hiddenpayeeid:eq(' + payeeIndex + ')').val($('#id_payeelookup').val());

                    $.ajax({
                        url: "{% url 'supplier:getsupplierdata' %}",
                        type: "post",
                        data: {'supplierid': $('#id_payeelookup').val()
                        },
                        success: function(response) {
                            $('.select-currency:eq(' + payeeIndex + ')').val(response.currency);
                            $('.input-fxrate:eq(' + payeeIndex + ')').val((parseFloat(response.fxrate).toFixed(2)));
                            $('.input-payee:eq(' + payeeIndex + ')').data('currency', response.currency).data('fxrate', parseFloat(response.fxrate).toFixed(2));
                            $("#lookupModal .close").click();

                            $('.input-payee:eq(' + payeeIndex + ')').closest('tr').addClass('warning');
                        },
                        error: function(response) {
                            console.debug(response);
                        }
                    });
                }
            });

            /** Show other fields **/
            $(document).on('click', '.expand-fields', function(){
                $(this).parent().parent().parent().find('.extra-fields').slideToggle(500);
                if($(this).parent().hasClass('rotate-down')){
                    $(this).parent().removeClass('rotate-down').addClass('rotate-up')
                }
                else{
                    $(this).parent().removeClass('rotate-up').addClass('rotate-down')
                }
            });

            /** Onchange currency show fx rate **/
            $(document).on('change', '.select-currency', function(){
                $(this).parent().siblings().find('.input-fxrate').val($(this).find(':selected').attr('data-rate'));
            });

            $(document).on('change', '.item_input_ofsubtype', function () {
                if($(this).val() == {{ mealexpense }}){
                    $(this).parent().parent().find('.no_of_pax').parent().parent().show();
                }
                else {
                    $(this).parent().parent().find('.no_of_pax').parent().parent().hide();
                }
            });

            /** Add Item **/
            $(document).on('click', '#item_add', function(){
                if($('.item_table tbody tr.warning').length == 1){
                    collapseFields();
                    $('.item_hidden').last().clone().appendTo('.item_table tbody');
                    $('.item_hidden:nth-last-child(2)').removeClass('item_hidden').find('.item_input_ofsubtype').select2();
                    initMaskMoney('amount');
                    itemRecount();
                    assignSubtypeOption(2);
                }
                else{
                    customAlert($('#item-add-error'));
                }
            });

            /** Store Item **/
            $(document).on('click', '.item_save', function(){
                /* Some validations */
                if($(this).parent().parent().find('.item_input_ofsubtype').val() == '' ||
                        $(this).parent().parent().find('.input-payee').val() == '' ||
                        $(this).parent().parent().find('.input-amount').val() == '' ||
                        $(this).parent().parent().find('.select-currency').val() == '' ||
                        $(this).parent().parent().find('.input-fxrate').val() == '' ||
                        $(this).parent().parent().find('.input-fxrate').val() == '0.00' ||
                        $(this).parent().parent().find('.text-particulars').val() == '0.00'){
                    customAlert($('#item-save-error'));
                }
                else {
                    if($('#id_oftype option:selected').text().indexOf("Cellphone Subsidy") >= 0){
                        if($(this).parent().parent().find('.datepicker-periodfrom').val() == '' ||
                                        $(this).parent().parent().find('.datepicker-periodto').val() == ''){
                            customAlert($('#item-save-error'));
                        }
                        else {
                            saveItem(this);
                        }
                    }
                    else if($(this).parent().parent().find('.item_input_ofsubtype').val() == {{ mealexpense }}){
                        if($(this).parent().parent().find('.no_of_pax').val() == 0 || $(this).parent().parent().find('.no_of_pax').val() == ''){
                            customAlert($('#item-save-error'));
                        }
                        else {
                            saveItem(this);
                        }
                    }
                    else {
                        saveItem(this);
                    }
                }
            });

            /** Delete Item **/
            $(document).on('click', '.item_delete', function(){
                var item = $(this).parent().parent().parent();
                if(item.hasClass('warning')){
                    /* quick delete */
                    item.remove();
                }
                else{
                    /* table delete */
                    if(confirm('Are you sure you want to delete this item?')){
                        /* Ajax delete */
                        $.ajax({
                            url: "{% url 'operationalfund:deleteitemtemp' %}",
                            type: "post",
                            data: {
                                'id_itemtemp': $(this).siblings('.item_save').data('itemid')
                            },
                            success: function(response){
                                item.remove();
                                itemRecount();
                                customAlert($('#item-delete-success'));
                                computeTotalAmount();
                            }, error: function(response) {
                                console.debug(response);
                            }
                        });
                    }
                }
            });

            /** Store OF **/
{#            $(document).on('click', '#validateButton', function(){#}
{#                if($('.item_table tbody tr').length > $('.item_table tbody tr.warning').length){#}
{#                    /* other validations */#}
{##}
{#                    $("#form-b").submit();#}
{#                }#}
{#                else{#}
{#                    customAlert($('#of-save-error'));#}
{#                }#}
{#            });#}
            $(document).on('click', '#validateButton', function(){
                if($('.item_table tbody tr').length > $('.item_table tbody tr.warning').length){
                    if(parseFloat($('#totalamount').text().replace(',','')) <= 1000 || $('#id_oftype').val() != 1){
                        if(parseFloat($('#totalamount').text().replace(',','')) <= parseFloat($('#id_requestor option:selected').data('amount')) || $('#id_oftype').val() != 3){
                            $("#form-b").submit();
                        }
                        else {
                            customAlert($('#of-save-amount-error2'));
                            event.preventDefault();
                        }
                    }
                    else{
                        {% if object.ofstatus == 'F' %}
                            customAlert($('#of-save-amount-error'));
                            event.preventDefault();
                        {% else %}
                            $("#form-b").submit();
                        {% endif %}
                    }
                }
                else{
                    customAlert($('#of-save-error'));
                    event.preventDefault();
                }
            });

            /** Onchange payee text **/
            $(document).on('input', '.input-payee', function(){
                if($(this).val() == $(this).parent().siblings('.input-hiddenpayee').val()){
                    $(this).parent().parent().parent().find('.select-currency').val($(this).data('currency'));
                    $(this).parent().parent().parent().find('.input-fxrate').val($(this).data('fxrate'));
                }
                else {
                    $(this).parent().parent().parent().find('.select-currency').val("1");
                    $(this).parent().parent().parent().find('.input-fxrate').val("1.00");
                }
            });

            /** Onchange all **/
            $(document).on('change', '.item_input_ofsubtype, ' +
                                     '.input-payee, .input-amount, ' +
                                     '.select-currency, ' +
                                     '.input-fxrate, ' +
                                     '.datepicker-periodfrom, ' +
                                     '.datepicker-periodto, ' +
                                     '.text-particulars, .no_of_pax', function(e){
                $(this).closest('tr').addClass('warning');
            });

            /** Onkeypress no_of_pax **/
            $(document).on('change', '.no_of_pax', function() {
                if($(this).val() != '' && $(this).val() != '0' && $(this).is(":visible") &&
                    $(this).parent().parent().parent().parent().find('.input-amount').val() != '0.00' &&
                    $(this).parent().parent().parent().parent().find('.input-amount').val() != ''){
                    var no_of_pax = parseFloat($(this).val());
                    var budget_spent = parseFloat($(this).parent().parent().parent().parent().find('.input-amount').val().replace(',',''));
                    var budget_limit = parseFloat({{ mealbudget }});
                    if(showBudgetWarning(no_of_pax, budget_spent, budget_limit)){
                        $(this).parent().parent().find('.budget_warning').show();
                    }
                    else {
                        $(this).parent().parent().find('.budget_warning').hide();
                    }
                }
            });

            /** Onkeypress input-amount **/
            $(document).on('change', '.input-amount', function() {
                if($(this).val() != '' && $(this).val() != '0.00' &&
                    $(this).parent().parent().find('.no_of_pax').val() != '0' &&
                    $(this).parent().parent().find('.no_of_pax').val() != '' && $(this).parent().parent().find('.no_of_pax').is(":visible")){
                    var no_of_pax = parseFloat($(this).parent().parent().find('.no_of_pax').val());
                    var budget_spent = parseFloat($(this).val().replace(',',''));
                    var budget_limit = parseFloat({{ mealbudget }});
                    if(showBudgetWarning(no_of_pax, budget_spent, budget_limit)){
                        $(this).parent().parent().find('.budget_warning').show();
                    }
                    else {
                        $(this).parent().parent().find('.budget_warning').hide();
                    }
                }
            });

            function showBudgetWarning(no_of_pax, budget_spent, budget_limit){
                return budget_spent/no_of_pax > budget_limit;
            }

            function itemRecount(){
                var item_count = 1;
                $('.item_counter').each(function(){
                    $(this).html(item_count);
                    item_count++;
                })
            }

            function assignSubtypeOption(command){
{#                initializeDateRange();#}
                $('.item_input_ofsubtype:not(:last)').find('option').prop( "disabled", true );
                $('.item_input_ofsubtype:not(:last)').find('option[data-oftype=' + $('#id_oftype').val() + ']').prop( "disabled", false );
                if(command == 1){
                    $('.item_input_ofsubtype:not(:last)').select2("destroy").select2().val('').trigger('change.select2');
                }
                else if(command == 2){
                    $('.item_input_ofsubtype:not(:last)').select2("destroy").select2().trigger('change.select2');
                }
                if ($('#id_oftype option:selected').text().toLowerCase().indexOf("cellphone subsidy") >= 0){
                    $('.datepicker-periodfrom').parent().show();
                    $('.datepicker-periodto').parent().show();
                }
                else {
                    $('.datepicker-periodfrom').parent().hide();
                    $('.datepicker-periodto').parent().hide();
                }
            }

            function collapseFields(){
                $('.rotate-icon:not(:last)').removeClass('rotate-up').addClass('rotate-down');

                var transTime = 400;
                $('.extra-fields:not(:last)').each(function(){
                    $(this).slideUp(transTime);
                    /* transTime = transTime + 200; */
                });


            }

            function saveItem(saveButton){
                $.ajax({
                    url: "{% url 'operationalfund:saveitemtemp' %}",
                    type: "post",
                    data: {
                        'id_itemtemp': $(saveButton).data('itemid'),
                        'itemno': $(saveButton).parent().siblings('.item_counter').text(),
                        'secretkey': $("#secretkey").val(),
                        'id_oftype': $("#id_oftype").val(),
                        'id_ofsubtype': $(saveButton).parent().parent().find('.item_input_ofsubtype').val(),
                        'id_payee': $(saveButton).parent().parent().find('.input-payee').val(),
                        'id_hiddenpayee': $(saveButton).parent().parent().find('.input-hiddenpayee').val(),
                        'id_hiddenpayeeid': $(saveButton).parent().parent().find('.input-hiddenpayeeid').val(),
                        'id_amount': $(saveButton).parent().parent().find('.input-amount').val(),
                        'id_particulars': $(saveButton).parent().parent().find('.text-particulars').val(),
                        'id_currency': $(saveButton).parent().parent().find('.select-currency').val(),
                        'id_fxrate': $(saveButton).parent().parent().find('.input-fxrate').val(),
                        'id_periodfrom': $(saveButton).parent().parent().find('.datepicker-periodfrom').val(),
                        'id_periodto': $(saveButton).parent().parent().find('.datepicker-periodto').val(),
                        'id_noofpax': $(saveButton).parent().parent().find('.no_of_pax').val()
                    },
                    success: function(response){
                        $(saveButton).parent().parent().parent().removeClass('warning');
                        customAlert($('#item-save-success'));
                        computeTotalAmount();
                        $(saveButton).data('itemid', response.itemtempid);
                    }, error: function(response) {
                        console.debug(response);
                    }
                });
            }

            function computeTotalAmount(){
                var totalAmount = 0;
                $('.item_save').each(function(){
                    if($(this).parent().parent().find('.input-amount').val() && !$(this).closest('tr').hasClass('warning')){
                        totalAmount += parseFloat($(this).parent().parent().find('.input-amount').val().replace( /,/g, ""));
                    }
                });
                $('#totalamount').text(totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            }
        });
    </script>
{% endblock extra_js %}