{% load humanize %}
{% load mathfilters %}
{% load custom %}
{% load staticfiles %}
<link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" />
<script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/custom-datepicker.js' %}"></script>
<style>
    .pointer{
        cursor: pointer;
    }
    .form-group{
        margin-bottom: 5px;
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
<div class="col-md-12 col-sm-12 col-xs-12">
    <div class="page-wrap">
        <h3>Transaction Listing</h3>
        {% if data %}
        {% if import_count > 1%}
            <a href="{% url 'prepaidaccrual:importprepaidschedule' %}?from={{ dfrom }}&to={{ dto }}" target="_blank" title="{{ import_count }} transactions pending for import." class="btn btn-primary waves-effect waves-dark floatright" id="import-schedule" style="margin: 10px 0">
                <i class="icon fa-file" aria-hidden="true"></i>&nbsp;&nbsp;Import {{ import_count }} new transactions
            </a>
        {% elif import_count == 1 %}
            <a href="{% url 'prepaidaccrual:importprepaidschedule' %}?from={{ dfrom }}&to={{ dto }}" target="_blank" title="{{ import_count }} transaction pending for import." class="btn btn-primary waves-effect waves-dark floatright" id="import-schedule" style="margin: 10px 0">
                <i class="icon fa-file" aria-hidden="true"></i>&nbsp;&nbsp;Import {{ import_count }} new transaction
            </a>
        {% endif %}
            <table class="table table-striped table-bordered" style="font-size:12px">
                <thead>
                    <tr>
                        <th colspan="2">Reference</th>
                        <th>Date</th>
                        <th>Payee</th>
                        <th>Particulars</th>
                        <!-- <th>Beginning Balance as of 12/31/2022	</th> -->
                        <th>Amount</th>
                        <th>Expense Account</th>
                        <th>Expense Description</th>
                        <th>Department</th>
                        <th>Branch</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in data %}
                    <tr {% if item.supplier.code == None %} class="text-danger" {% endif %}>
                        <td class="text-left">{{ item.transaction_type }}</td>
                        <td class="text-left">{{ item.transaction_number }}</td>
                        <td class="text-left">{{ item.date|date:'Y-m-d' }}</td>
                        <td class="text-left ">
                            <span class="pointer" onclick="editTransaction('{{ item.id }}', is_duplicate=false)" data-toggle='modal' data-target='#dataEntryModal'>{{ item.supplier.name|default:"NO PAYEE/SUPPLIER" }} - {{ item.supplier.code|default:"N/A" }}</span>
                            <span class="pointer {% if item.no_of_month %}text-primary{% else %}text-danger{% endif %} pen{{ item.id }}" 
                                title="Edit transaction" data-toggle='modal' data-target='#dataEntryModal'
                                onclick="editTransaction('{{ item.id }}', is_duplicate=false)"
                            >
                                &nbsp;&nbsp;&nbsp;&nbsp; <i class="icon fa-edit"></i> &nbsp;&nbsp;&nbsp;&nbsp;
                            </span>
                        </td>
                        <td class="text-left">{{ item.particulars }}</td>
                        <!-- <td class="text-right">{{ item.debitamount|intcomma }}</td> -->
                        <td class="text-right">{{ item.amount|floatformat:2|intcomma }}</td>
                        <td class="text-left">{{ item.expense_account.accountcode }}</td>
                        <td class="text-left">{{ item.expense_account.description }}</td>
                        <td class="text-left">{{ item.department.code }}</td>
                        <td class="text-left">{{ item.branch.code }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="5" class="text-right">Total</td>
                    <td class="text-right">{{ total|floatformat:2|intcomma }}</td>
                </tr>
                </tbody>
            </table>
        {% else %}
        <br>
        <span>No Prepaid Schedule data found. <a href="{% url 'prepaidaccrual:importprepaidschedule' %}?from={{ dfrom }}&to={{ dto }}" target="_blank">Import {{ import_count }} transactions for data entry here.</a></span>
        
        {% endif %}
        <input type="hidden" id="duplicate_entry_id">
    </div>

    <!-- data entry modal -->
    <div id="dataEntryModal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-left">Prepaid Expense Transaction Entry</h4>
                    <input type="hidden" id="datamodal_id">
                </div>
                <div class="modal-body" style="max-height: calc(100vh - 190px); overflow-y: auto !important;">
                    <br>
                    <div class="col-md-12 text-primary">
                        <div class="row">
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Supplier:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_suppliercode" readonly>
                                </div>
                                <div class="form-group col-md-6">
                                    <input type="text" class="form-control" id="datamodal_suppliername" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Account Code:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_accountcode" readonly>
                                </div>
                                <div class="form-group col-md-6">
                                    <input type="text" class="form-control" id="datamodal_accountname" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Date:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_date" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Reference:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_transactiontype" readonly>
                                </div>
                                <div class="form-group col-md-6">
                                    <input type="text" class="form-control" id="datamodal_transactionnumber" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Code:</label>
                                </div>
                                <div class="form-group col-md-2 text-left" style="color: #333;">
                                    <span id="text_datamodal_code"></span>
                                </div>
                                <div class="form-group col-md-2 text-left">
                                    <label class="control-label">Amount:</label>
                                </div>
                                <div class="form-group col-md-4" id="datamodal_amount_required">
                                    <input type="text" class="form-control text-right" id="datamodal_amount">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group col-md-12 extra-field" style="margin-top: 20px;">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Number of Months:</label>
                                </div>
                                <div class="form-group col-md-2" id="datamodal_numberofmonth_required">
                                    <input type="number" class="form-control text-right" id="datamodal_numberofmonth">
                                </div>
                                <div class="col-md-2">
                                    <div class="text-left">
                                        <button type="button" class="btn btn-sm btn-default" id="compute_btn"><b>Compute</b></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Start & End Date:</label>
                                </div>
                                <div class="form-group col-md-2" id="datamodal_startdate_required">
                                    <input type="text" class="form-control text-left" placeholder="yyyy-mm-dd" id="datamodal_startdate">
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control text-left" placeholder="yyyy-mm-dd" id="datamodal_enddate" readonly>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-right">
                                        <button type="button" class="btn btn-sm btn-default" style="display: none;" id="duplicate_btn" title="Duplicate Transaction Entry">Duplicate Entry</button>
                                        <input type="hidden" id="is_duplicate" >
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Computed Amortization:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control text-right" id="datamodal_computedamortization" placeholder="0.00" readonly>
                                </div>
                                
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Actual Amortization:</label>
                                </div>
                                <div class="form-group col-md-2" id="datamodal_actualamortization_required">
                                    <input type="text" class="form-control text-right" id="datamodal_actualamortization" placeholder="0.00">
                                </div>
                                <div class="col-md-4">
                                    <div class="text-left">
                                        <button type="button" class="btn btn-sm btn-default" id="recompute_btn" title="Click recompute when Computed Amortization is different from Actual Amortization.">Recompute</button>
                                        <button type="button" class="btn btn-sm btn-primary" id="show_detail_btn">Show Detail</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field" style="margin-top: 20px;">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Expense Account:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_expenseaccountcode">
                                </div>
                                <div class="form-group col-md-6" id="datamodal_expenseaccount_required">
                                    <select class="form-control input-sm" required style="width: 100%" id="datamodal_expenseaccount">
                                        <option value="" disabled selected>-- Select --</option>
                                        {% for exp in expense_accounts %}
                                            <option value="{{ exp.id }}" data-expenseaccountcode="{{ exp.accountcode }}" data-departmentenable="{{ exp.department_enable }}" data-branchenable="{{ exp.branch_enable }}">[{{ exp.accountcode }}] - {{ exp.description }}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- <input type="text" class="form-control" id="datamodal_expenseaccountdescription"> -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Department:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_departmentcode">
                                </div>
                                <div class="form-group col-md-6" id="department_required">
                                    <select class="form-control input-sm" style="width: 100%" id="datamodal_department">
                                        <option value="" disabled selected>-- Select --</option>
                                        {% for dep in departments %}
                                            <option value="{{ dep.id }}" data-departmentcode="{{ dep.code }}">[{{ dep.code }}] - {{ dep.departmentname }}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- <input type="text" class="form-control" id="datamodal_departmentname"> -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Branch:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control" id="datamodal_branchcode">
                                </div>
                                <div class="form-group col-md-6" id="branch_required">
                                    <select class="form-control input-sm" style="width: 100%" id="datamodal_branch">
                                        <option disabled selected>-- Select --</option>
                                        {% for bra in branches %}
                                            <option value="{{ bra.id }}" data-branchcode="{{ bra.code }}">[{{ bra.code }}] - {{ bra.description }}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- <input type="text" class="form-control" id="datamodal_branchdescription"> -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Remarks:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <input type="text" class="form-control" id="datamodal_remarks">
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Particulars:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <input type="text" class="form-control" id="datamodal_particulars">
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 extra-field">
                            <div class="row">
                                <div class="form-group col-md-4 text-left">
                                    <label class="control-label">Status:</label>
                                </div>
                                <div class="form-group col-md-4 text-left">
                                    <span id="text_datamodal_status"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <hr>
                    <br>
                    <div id="results"></div>
                   
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-info" id="save_transaction" title="Save">Save</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end data entry modal -->
    <!-- modal edit amount -->
    <div id="editAmountModal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 450px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Edit Amortization Amount</h4>
                </div>
                <div class="modal-body" style="overflow:hidden;">
                    <div class="row">
                        <div class="form-group col-md-12">
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4">
                                    <label class="control-label" for="edit_amount">Amount:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <input type="text" class="form-control input-sm"
                                           style="padding: 5px 10px" id="edit_amount" name="edit_amount">
                                </div>
                            </div>
                            <input type="hidden" id="edit_id">
                            <input type="hidden" id="amount_label">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-sm btn-info" id="edit_amount_btn" title="Click to save">Update</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end modal edit amount -->
</div>
<div class="clearfix"></div>

<script>

    const intRegex = /^\d+$/;
    const floatRegex = /^((\d+(\.\d *)?)|((\d*\.)?\d+))$/;

    function resetModalFields(){
        $('#datamodal_id').val('');
        $('#datamodal_suppliercode').val('');
        $('#datamodal_suppliername').val('');
        $('#datamodal_accountcode').val('');
        $('#datamodal_accountname').val('');
        $('#datamodal_date').val('');
        $('#datamodal_transactiontype').val('');
        $('#datamodal_transactionnumber').val('');
        $('#text_datamodal_code').text('');
        $('#datamodal_amount').val('');
        $('#datamodal_numberofmonth').val('');
        $('#datamodal_startdate').val('');
        $('#datamodal_enddate').val('');
        $('#datamodal_computedamortization').val('');
        $('#datamodal_actualamortization').val('');
        $('#datamodal_expenseaccountcode').val('');
        $('#datamodal_expenseaccount').val('');
        $('#datamodal_departmentcode').val('');
        $('#datamodal_department').val('');
        $('#datamodal_branchcode').val('');
        $('#datamodal_branchdescription').val('');
        $('#datamodal_remarks').val('');
        $('#datamodal_particulars').val('');
        $('#text_datamodal_status').text('');

        const requiredAttributes = ['datamodal_amount_required', 'datamodal_numberofmonth_required', 'datamodal_startdate_required', 'datamodal_actualamortization_required', 'datamodal_expenseaccount_required'];
        for (var i=0; i < requiredAttributes.length; i++){
            $(`#${requiredAttributes[i]}`).removeClass('has-error');
        }

        $('#results').html('');
        
    }

    function calculateAmortization(principalAmount, numberOfMonths, startDate) {
        const monthlyAmortization = parseFloat((principalAmount / numberOfMonths).toFixed(2));

        // Distribute the monthly amortization across the specified number of months
        const amortizationArray = new Array(numberOfMonths).fill(monthlyAmortization);

        // Adjust the last month's amount to ensure no centavo is missed
        const totalAmortization = principalAmount;
        const remainingCents = parseFloat((totalAmortization - amortizationArray.reduce((sum, amount) => sum + amount, 0)).toFixed(2));
        amortizationArray[numberOfMonths - 1] += remainingCents;
        
        const scheduleStartDate = new Date(startDate);
        const amortizationSchedule = [];

        for (let i = 0; i < numberOfMonths; i++) {
            const currentMonth = new Date(scheduleStartDate.getFullYear(), scheduleStartDate.getMonth() + i);

            // Calculate the number of days in the current month
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();

            // Set the day of the month, considering edge cases
            const dayOfMonth = Math.min(scheduleStartDate.getDate(), daysInMonth);
            currentMonth.setDate(dayOfMonth);

            const dateParts = currentMonth.toLocaleDateString('en-US').split("/");
            amortizationSchedule.push({
                date: `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`,
                month: currentMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' }),
                amount: amortizationArray[i]
            });
        }

        return amortizationSchedule;
    }

    function showRetrievedDetail(amortizationSchedule){
        
        $('#results').fadeOut(400).html('');
        let resultsHtml = '<p class="text-left"><i>View Amortization Schedule:</i></p>';
        resultsHtml += '<div class="table-responsive">';
        resultsHtml += '<table class="table table-bordered table-hover">';
        resultsHtml += '<thead>';
        resultsHtml += '<tr>';
        resultsHtml += '<th>No.</th>';
        resultsHtml += '<th>Month</th>';
        resultsHtml += '<th>Supplier</th>';
        resultsHtml += '<th>Amortization</th>';
        resultsHtml += '<th>Total Amortization</th>';
        resultsHtml += '<th>Ending Balance</th>';
        resultsHtml += '<th>Expense Account</th>';
        resultsHtml += '<th>Department</th>';
        resultsHtml += '<th>Branch</th>';
        resultsHtml += '<th>Remarks</th>';
        resultsHtml += '<th>JV No.</th>';
        resultsHtml += '<th>JV Date</th>';
        resultsHtml += '</tr>';
        resultsHtml += '</thead>';
        resultsHtml += '<tbody>';

        const supplierCode = $('#datamodal_suppliercode').val();
        const supplierName = $('#datamodal_suppliername').val();
        let expenseAccount = '';
        let department = '';
        let branch = '';
        // const expenseAccountCode = $('#datamodal_expenseaccountcode').val();
        if($('#datamodal_expenseaccount').find(":selected").val() !== ''){
            expenseAccount = $('#datamodal_expenseaccount').find(":selected").text();
        }
        // const departmentCode = $('#datamodal_departmentcode').val();
        if($('#datamodal_department').find(":selected").val() !== ''){
            department = $('#datamodal_department').find(":selected").text();
        }
        // const branchCode = $('#datamodal_branchcode').val();
        if($('#datamodal_branch').find(":selected").val() !== ''){
            branch = $('#datamodal_branch').find(":selected").text();
        }
        const remarks = $('#datamodal_remarks').val();
        const totalAmount = amortizationSchedule.reduce((n, {amount}) => n + parseFloat(amount), 0);
        
        let totalAmortization = 0;
        let endingBalance = totalAmount;
        // console.log(amortizationSchedule);
        for (let i = 0; i < amortizationSchedule.length; i++) {
            const item = i + 1;
            const month = amortizationSchedule[i].month;
            const date = amortizationSchedule[i].date;
            const amount = parseFloat(amortizationSchedule[i].amount);
            const formattedAmount = formatCurrency(amount);

            const jvnum = (amortizationSchedule[i].jvnum) ? amortizationSchedule[i].jvnum : '';
            const postDatetime = (amortizationSchedule[i].postdate) ? amortizationSchedule[i].postdate : '';
            const postDate = (postDatetime) ? postDatetime.split('T')[0] : '';
            
            totalAmortization += amount;
            endingBalance = avoidNegativeZero(endingBalance - amount);
            if(amortizationSchedule[i].jvmain_id){
                resultsHtml += `<tr class="amort-row text-success" title="Posted to JV" data-item="${item}" data-date="${date}" data-month="${month}" data-amount="${amount}" data-totalamortization="${totalAmortization}" data-endingbalance="${endingBalance}" data-detailid="${amortizationSchedule[i].id}">`;
            } else {
                resultsHtml += `<tr class="amort-row" data-item="${item}" data-date="${date}" data-month="${month}" data-amount="${amount}" data-totalamortization="${totalAmortization}" data-endingbalance="${endingBalance}" data-detailid="${amortizationSchedule[i].id}">`;
            }
            resultsHtml += `<td class="text-left">${item}</td>`;
            resultsHtml += `<td class="text-left"><b>${month}</b></td>`;
            resultsHtml += `<td class="text-left">[${supplierCode}] - ${supplierName}</td>`;
            if(amortizationSchedule[i].jvmain_id){
                resultsHtml += `<td class="text-right"><b class="amount-label${i}">${formattedAmount}</b></td>`;
            } else {
                resultsHtml += `<td class="pointer text-right" ondblclick="editAmount(${amount}, ${amortizationSchedule[i].id}, 'amount-label${i}')"><b class="amount-label${i}">${formattedAmount}</b></td>`;
            }
            resultsHtml += `<td class="text-right">${formatCurrency(totalAmortization)}</td>`;
            resultsHtml += `<td class="text-right">${formatCurrency(endingBalance)}</td>`;
            resultsHtml += `<td class="text-left">${expenseAccount}</td>`;
            resultsHtml += `<td class="text-left">${department}</td>`;
            resultsHtml += `<td class="text-left">${branch}</td>`;
            resultsHtml += `<td class="text-left">${remarks}</td>`;
            resultsHtml += `<td class="text-left">${jvnum}</td>`;
            resultsHtml += `<td class="text-left">${postDate}</td>`;
            resultsHtml += '</tr>';
        }

        resultsHtml += '<tr class="warning">';
        resultsHtml += '<td class="text-right" colspan="3">Total</td>';
        resultsHtml += `<td class="text-right"><b>${formatCurrency(totalAmount)}</b></td>`;
        resultsHtml += '<td class="text-center text-danger" id="validation_message" colspan="8"></td>';
        resultsHtml += '</tr>';

        resultsHtml += '</tbody>';
        resultsHtml += '</table>';
        resultsHtml += '</div>';
        
        $('#results').fadeIn(100).html(resultsHtml);

        let originalAmount = $('#datamodal_amount').val();
        originalAmount = parseFloat(originalAmount.replace(/,/g, ''));
        const difference = originalAmount - totalAmount;
        const formattedDifference = (difference < 0) ? `(${Math.abs(difference).toFixed(2)})` : difference.toFixed(2);
        
        if (parseFloat(formattedDifference) > 0) {
            $('td#validation_message').html('<b>Warning: The total differs by ' + formattedDifference + '</b>');
        } else {
            $('td#validation_message').html('');
        }

        return true;
    }

    function formatCurrency(value) {
        return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function avoidNegativeZero(value){
        return Math.abs(value) < 0.000001 ? 0 : value;
    }

    function editAmount(amount, id, amountLabel){
        $('#editAmountModal').modal('show');
        $('#edit_amount').val(formatCurrency(amount));
        $('#edit_amount').focus();

        $('#edit_id').val(id);
        $('#amount_label').val(amountLabel);
    }

    function editTransaction(id, is_duplicate) {

        resetModalFields();
        $('#duplicate_entry_id').val(id);

        $('#compute_btn').show();
        $('#recompute_btn').show();
        $('#show_detail_btn').show();

        $.ajax({
            url: "{% url 'prepaidaccrual:getprepaiddata' %}",
            type: "GET",
            data: {
                csrfmiddlewaretoken: "{{ csrf_token }}",
                id: id,
            },
            success: function (response){
                if(response.responseCode === 200){

                    $('#datamodal_id').val(id);
                    $('#datamodal_suppliercode').val(response.suppliercode);
                    $('#datamodal_suppliername').val(response.suppliername);
                    $('#datamodal_accountcode').val(response.accountcode);
                    $('#datamodal_accountname').val(response.accountname);
                    $('#datamodal_date').val(response.date);
                    $('#datamodal_transactiontype').val(response.transactiontype);
                    $('#datamodal_transactionnumber').val(response.transactionnumber);
                    $('#text_datamodal_code').text(response.code);
                    $('#datamodal_amount').val(response.amount);
                    $('#datamodal_numberofmonth').val(response.numberofmonth);
                    $('#datamodal_startdate').val(response.startdate);
                    $('#datamodal_startdate').attr('min', response.startdate);
                    $('#datamodal_enddate').val(response.enddate);

                    let computedamortization = response.computedamortization !== '0.00' ? response.computedamortization : '';
                    let actualamortization = response.actualamortization !== '0.00' ? response.actualamortization : '';
                    $('#datamodal_computedamortization').val(computedamortization);
                    $('#datamodal_actualamortization').val(actualamortization);
                    
                    $('select#datamodal_expenseaccount').val(response.expenseaccountid).change();
                    $('#datamodal_expenseaccountcode').val($('#datamodal_expenseaccount').find(':selected').data('expenseaccountcode'));
                    
                    if(is_duplicate){
                        $('select#datamodal_department').val('').change();
                        $('#datamodal_departmentcode').val('');
                        $('#datamodal_remarks').fadeIn('slow').val('Duplicate entry for '+response.transactiontype+' #'+response.transactionnumber);
                        $('#is_duplicate').val('1');
                    } else {
                        $('select#datamodal_department').val(response.departmentid).change();
                        $('#datamodal_departmentcode').val($('#datamodal_department').find(':selected').data('departmentcode'));
                        $('#datamodal_remarks').val(response.remarks);
                        $('#duplicate_btn').show();
                        $('#is_duplicate').val('0');
                    }
                    
                    $('select#datamodal_branch').val(response.branchid).change();
                    $('#datamodal_branchcode').val($('#datamodal_branch').find(':selected').data('branchcode'));
                    
                    $('#datamodal_particulars').val(response.particulars);
                    $('#text_datamodal_status').text(response.status);

                    if(response.status === 'Active'){
                        $('#text_datamodal_status').addClass('text-success');
                    } else if(response.status === 'Inactive'){
                        $('#text_datamodal_status').addClass('text-danger');
                    }
                    
                    const amortizationSchedule = response.detail;
                    if(amortizationSchedule.length > 0){
                        $('#compute_btn').hide();
                        $('#recompute_btn').hide();
                        $('#show_detail_btn').hide();

                        showRetrievedDetail(amortizationSchedule);

                    } else {
                        $('#result').html('<p>Prepaid expense schedule is not yet set.</p>');
                    }

                } else {
                    alert(response.message);
                }
            },
            error: function (response) {
                console.log("err "+JSON.stringify(response));
                alert('An internal error occurred');
            }
        });
    }

    function validateDetail(){
        const amortizationData = [];
        let total = 0;
        $('.amort-row').each(function(){    
            var date = $(this).data('date');
            var month = $(this).data('month');
            var amount = $(this).data('amount');
            var id = $(this).data('detailid');

            total += amount;
            
            amortizationData.push({id, date, month, amount});
        });
        
        showRetrievedDetail(amortizationData);

        return true;
    }

    $('#edit_amount_btn').click(function(){

        let id = $('#edit_id').val();
        let amount = $('#edit_amount').val();
        amount = amount.replace(/,/g, '').trim();

        if(intRegex.test(amount) || floatRegex.test(amount)){

            $.ajax({
                url: "{% url 'prepaidaccrual:editamount' %}",
                type: "POST",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'id': id,
                    'amount': amount
                },
                success: function (response){
                    if (response.status == 'success'){
                        alert('Update successful!');
                        $('#editAmountModal').modal('toggle');

                        const classToChange = $('#amount_label').val();

                        // real-time update of changed data to UI
                        let row = $(`.${classToChange}`).closest('tr');
                        row.attr('data-amount', parseFloat(amount.replace(/,/g, '')));
                        $(`.${classToChange}`).text(amount);

                        validateDetail();
                    } else {
                        alert(response.message);
                    }
                },
                error: function (response) {
                    console.log("err "+JSON.stringify(response));
                }
            });
        } else {
            alert('Please enter valid amount.');
        }
    });

    $(function(){
        
        $('#datamodal_expenseaccount').select2({});
        $('#datamodal_department').select2({});
        $('#datamodal_branch').select2({});

        let amortizationSchedule = [];
        
        $('#compute_btn').click(function(){
            $(this).text('computing....');
            $('#show_detail_btn').hide();
            const amount = $('#datamodal_amount').val();
            const months = $('#datamodal_numberofmonth').val();

            const principalAmount = parseFloat(amount.replace(/,/g, ''));
            const numberOfMonths = parseInt(months, 10);

            const startDate = $('#datamodal_startdate').val();

            if(isNaN(principalAmount) || isNaN(numberOfMonths) || numberOfMonths <= 0 || startDate === ''){
                alert('Please enter valid numbers for Amount, Number of Months, and Start Date.');
                $('#datamodal_numberofmonth').val('');
                $(this).text('Compute');
                return;
            }
            
            amortizationSchedule = calculateAmortization(principalAmount, numberOfMonths, startDate);
            $('#datamodal_computedamortization, #datamodal_actualamortization').val(formatCurrency(amortizationSchedule[0].amount)).change();
            const endDate = amortizationSchedule[amortizationSchedule.length - 1]['date'];
            
            $('#datamodal_enddate').val(endDate);
            $('#show_detail_btn').show();
            $(this).text('Compute');
        });

        $('#recompute_btn').click(function(){
            $(this).text('recomputing....');
            const actualAmortizationInput = $('#datamodal_actualamortization');
            const numberOfMonthsInput = $('#datamodal_numberofmonth');
            const amount = $('#datamodal_amount').val();
            const principalAmount = parseFloat(amount.replace(/,/g, ''));

            const actualAmortization = parseFloat(actualAmortizationInput.val().replace(/,/g, ''));

            // Check if inputs are valid numbers
            const numberOfMonths = parseInt(numberOfMonthsInput.val(), 10);
            const startDate = $('#datamodal_startdate').val();

            if(isNaN(principalAmount) || isNaN(numberOfMonths) || numberOfMonths <= 0 || startDate === ''){
                alert('Please enter valid numbers for Amount, Number of Months, and Start Date.');
                $('#datamodal_numberofmonth').val('');
                $(this).text('Recompute');
                return;
            }

            // Distribute the monthly amortization across the specified number of months
            const amortizationArray = new Array(numberOfMonths).fill(actualAmortization);

            // Adjust the last month's amount to ensure no centavo is missed
            const totalAmortization = principalAmount;
            const remainingCents = parseFloat((totalAmortization - amortizationArray.reduce((sum, amount) => sum + amount, 0)).toFixed(2));
            amortizationArray[numberOfMonths - 1] += remainingCents;

            const scheduleStartDate = new Date(startDate);
            const amortizationSchedule = [];

            for (let i = 0; i < numberOfMonths; i++) {
                const currentMonth = new Date(scheduleStartDate);
                currentMonth.setMonth(currentMonth.getMonth() + i);
                amortizationSchedule.push({
                    date: currentMonth.toISOString().slice(0, 10),
                    month: currentMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' }),
                    amount: amortizationArray[i]
                });
            }
            
            $(this).text('Recompute');
            showDetail(amortizationSchedule, principalAmount);
        });

        $('#show_detail_btn').click(function(){
            if (amortizationSchedule.length === 0){
                alert('Please click compute first');
                return;
            }
            const amount = $('#datamodal_amount').val();
            const principalAmount = parseFloat(amount.replace(/,/g, ''));

            const computedAmortization = $('#datamodal_computedamortization').val();
            const computedAmount = parseFloat(computedAmortization.replace(/,/g, ''));
            
            const numberOfMonthsInput = $('#datamodal_numberofmonth');
            const numberOfMonths = parseInt(numberOfMonthsInput.val(), 10);

            if (isNaN(principalAmount) || computedAmount <= 0 || isNaN(numberOfMonths) || numberOfMonths <= 0) {
                alert('Please enter valid numbers for Actual Amortization and Number of Months.');
                numberOfMonthsInput.val('');
                return;
            }

            showDetail(amortizationSchedule, principalAmount);
        });

        $('#save_transaction').click(function(){
            var this_btn = $(this);
            const validationMsg = $('td#validation_message').text().trim();
            
            if(validationMsg === ''){

                const id = $('#datamodal_id').val();
                // const suppliercode = $('#datamodal_suppliercode').val();
                // const suppliername = $('#datamodal_suppliername').val();
                // const accountcode = $('#datamodal_accountcode').val();
                // const accountname = $('#datamodal_accountname').val();
                // const date = $('#datamodal_date').val();
                // const transactiontype = $('#datamodal_transactiontype').val();
                // const transactionnumber = $('#datamodal_transactionnumber').val();
                const amount = $('#datamodal_amount').val();
                const numberofmonth = $('#datamodal_numberofmonth').val();
                const startdate = $('#datamodal_startdate').val();
                const enddate = $('#datamodal_enddate').val();
                const computedamortization = $('#datamodal_computedamortization').val();
                const actualamortization = $('#datamodal_actualamortization').val();
                // const expenseaccountcode = $('#datamodal_expenseaccountcode').val();
                const expenseaccount = $('#datamodal_expenseaccount').val();
                // const departmentcode = $('#datamodal_departmentcode').val();
                const department = $('#datamodal_department').val();
                // const branchcode = $('#datamodal_branchcode').val();
                const branch = $('#datamodal_branch').val();
                const remarks = $('#datamodal_remarks').val();
                const particulars = $('#datamodal_particulars').val();
                const isduplicate = $('#is_duplicate').val();
                
                const requiredFields = [amount, numberofmonth, startdate, actualamortization, expenseaccount];
                const requiredAttributes = ['datamodal_amount_required', 'datamodal_numberofmonth_required', 'datamodal_startdate_required', 'datamodal_actualamortization_required', 'datamodal_expenseaccount_required'];
                if($('#datamodal_department').prop('required')){
                    requiredFields.push(department);
                    requiredAttributes.push('department_required');
                }
                if($('#datamodal_branch').prop('required')){
                    requiredFields.push(branch);
                    requiredAttributes.push('branch_required');
                }
                var i = 0;
                valid = true;
                for (i; i < requiredFields.length; i++){
                    if(requiredFields[i] === '' || requiredFields[i] === undefined || requiredFields[i] === null){
                        valid = false;
                        $(`#${requiredAttributes[i]}`).addClass('has-error');
                    }
                }

                if(!valid){
                    alert('Please fill in required fields.');
                    return;
                }

                const amortizationData = [];
                $('.amort-row').each(function(){
                    var item = $(this).data('item');
                    var date = $(this).data('date');
                    var month = $(this).data('month');
                    var amount = $(this).data('amount');
                    var totalamortization = $(this).data('totalamortization');
                    var endingbalance = $(this).data('endingbalance');
                    
                    amortizationData.push({item, date, month, amount, totalamortization, endingbalance});
                });

                if(amortizationData.length === 0){
                    if(!confirm('Confirm saving entry without detail?')){
                        return;
                    }
                }

                $.ajax({
                    url: "{% url 'prepaidaccrual:saveprepaiddata' %}",
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                        'id': id,
                        'amount': amount.replace(/,/g, ''),
                        'numberofmonth': numberofmonth,
                        'startdate': startdate,
                        'enddate': enddate,
                        'computedamortization': computedamortization.replace(/,/g, ''),
                        'actualamortization': actualamortization.replace(/,/g, ''),
                        'expenseaccount': expenseaccount,
                        'department': department,
                        'branch': branch,
                        'remarks': remarks,
                        'particulars': particulars,
                        'schedule': JSON.stringify(amortizationData),
                        'isduplicate': isduplicate
                    },
                    success: function (response){
                        if (response.status == 'success'){
                            alert('saved successfully!');
                            $('#dataEntryModal').modal('toggle');
                            const pen = $('#datamodal_id').val();
                            $(`.pen${pen}`).removeClass('text-danger').addClass('text-primary');
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (response) {
                        console.log("err "+JSON.stringify(response));
                    }
                });
            } else {
                alert(validationMsg);
                return false;
            }
        });
    
        $('#duplicate_btn').click(function(){

            if(confirm('Are you sure to duplicate this transaction entry?')){
                $('#duplicate_btn').text('Duplicating...');
                $('#duplicate_btn').toggle( 'highlight' );

                const id = $('#duplicate_entry_id').val();
                const is_duplicate = true;
                editTransaction(id, is_duplicate);

                $('#duplicate_btn').text('Duplicate Entry');
            }
        });

        function showDetail(amortizationSchedule, principalAmount){
        
            $('#results').fadeOut(400).html('');
            let resultsHtml = '<p class="text-left"><i>View Amortization Schedule [Draft]:</i></p>';
            resultsHtml += '<div class="table-responsive">';
            resultsHtml += '<table class="table table-bordered table-hover">';
            resultsHtml += '<thead>';
            resultsHtml += '<tr>';
            resultsHtml += '<th>No.</th>';
            resultsHtml += '<th>Month</th>';
            resultsHtml += '<th>Supplier</th>';
            resultsHtml += '<th>Amortization</th>';
            resultsHtml += '<th>Total Amortization</th>';
            resultsHtml += '<th>Ending Balance</th>';
            resultsHtml += '<th>Expense Account</th>';
            resultsHtml += '<th>Department</th>';
            resultsHtml += '<th>Branch</th>';
            resultsHtml += '<th>Remarks</th>';
            resultsHtml += '<th>JV No.</th>';
            resultsHtml += '<th>JV Date</th>';
            resultsHtml += '</tr>';
            resultsHtml += '</thead>';
            resultsHtml += '<tbody>';

            const supplierCode = $('#datamodal_suppliercode').val();
            const supplierName = $('#datamodal_suppliername').val();

            let expenseAccount = '';
            let department = '';
            let branch = '';
            // const expenseAccountCode = $('#datamodal_expenseaccountcode').val();
            if($('#datamodal_expenseaccount').find(":selected").val() !== ''){
                expenseAccount = $('#datamodal_expenseaccount').find(":selected").text();
            }
            // const departmentCode = $('#datamodal_departmentcode').val();
            if($('#datamodal_department').find(":selected").val() !== ''){
                department = $('#datamodal_department').find(":selected").text();
            }
            // const branchCode = $('#datamodal_branchcode').val();
            if($('#datamodal_branch').find(":selected").val() !== ''){
                branch = $('#datamodal_branch').find(":selected").text();
            }
            const remarks = $('#datamodal_remarks').val();
            const totalAmount = amortizationSchedule.reduce((n, {amount}) => n + amount, 0);
            
            let totalAmortization = 0;
            let endingBalance = totalAmount;
            // console.log(amortizationSchedule);

            for (let i = 0; i < amortizationSchedule.length; i++) {
                const item = i + 1;
                const month = amortizationSchedule[i].month;
                const date = amortizationSchedule[i].date;
                const amount = amortizationSchedule[i].amount;
                const formattedAmount = formatCurrency(amount);
                
                totalAmortization += amount;
                endingBalance = avoidNegativeZero(endingBalance - amount);

                resultsHtml += `<tr class="amort-row" data-item="${item}" data-date="${date}" data-month="${month}" data-amount="${amount}" data-totalamortization="${totalAmortization}" data-endingbalance="${endingBalance}">`;
                resultsHtml += `<td class="text-left">${item}</td>`;
                resultsHtml += `<td class="text-left"><b>${month}</b></td>`;
                resultsHtml += `<td class="text-left">[${supplierCode}] - ${supplierName}</td>`;
                resultsHtml += `<td class="text-right"><b title="Please save first to edit.">${formattedAmount}</b></td>`;
                resultsHtml += `<td class="text-right">${formatCurrency(totalAmortization)}</td>`;
                resultsHtml += `<td class="text-right">${formatCurrency(endingBalance)}</td>`;
                resultsHtml += `<td class="text-left">${expenseAccount}</td>`;
                resultsHtml += `<td class="text-left">${department}</td>`;
                resultsHtml += `<td class="text-left">${branch}</td>`;
                resultsHtml += `<td class="text-left">${remarks}</td>`;
                resultsHtml += `<td class="text-left"></td>`;
                resultsHtml += `<td class="text-left"></td>`;
                resultsHtml += '</tr>';
            }

            resultsHtml += '<tr class="warning">';
            resultsHtml += '<td class="text-right" colspan="3">Total</td>';
            resultsHtml += `<td class="text-right"><b>${formatCurrency(totalAmount)}</b></td>`;
            resultsHtml += '<td class="text-right" colspan="8"></td>';
            resultsHtml += '</tr>';

            resultsHtml += '</tbody>';
            resultsHtml += '</table>';
            resultsHtml += '</div>';
            
            $('#results').fadeIn(100).html(resultsHtml);
        }

        $('#datamodal_department').change(function(){
            if($(this).val() !== null){
                $('#department_required').removeClass('has-error');
            }
        });
        $('#datamodal_branch').change(function(){
            if($(this).val() !== null){
                $('#branch_required').removeClass('has-error');
            }
        });
        $('#datamodal_numberofmonth').on('change', function(){
            if($(this).val() !== ''){
                $('#datamodal_numberofmonth_required').removeClass('has-error');
            }
        });
        $('#datamodal_startdate').on('change', function(){
            if($(this).val() !== ''){
                $('#datamodal_startdate_required').removeClass('has-error');
            }
        });
        $('#datamodal_actualamortization').on('change', function(){
            if($(this).val() !== ''){
                $('#datamodal_actualamortization_required').removeClass('has-error');
            }
        });
        
        $('#datamodal_expenseaccount').change(function(){
            const selected = $('#datamodal_expenseaccount').find(':selected');

            if(selected.val() !== null){
                $('#datamodal_expenseaccount_required').removeClass('has-error');
            }

            const department_enable = selected.data('departmentenable');
            const branch_enable = selected.data('branchenable');
            
            if(department_enable == 'Y'){
                if($('select#datamodal_department').val() === null){
                    $('#department_required').addClass('has-error');
                } else {
                    $('#department_required').removeClass('has-error');
                }

                $('#datamodal_departmentcode').attr('disabled', false);
                $('#datamodal_department').attr('disabled', false);
                $('#datamodal_department').attr('required', true);
            } else {
                $('#department_required').removeClass('has-error');
                $('#datamodal_department').val('').change();
                $('#datamodal_departmentcode').val('');
                $('#datamodal_departmentcode').attr('disabled', true);
                $('#datamodal_department').attr('disabled', true);
                $('#datamodal_department').attr('required', false);
            }

            if(branch_enable == 'Y'){
                if($('select#datamodal_branch').val() === null){
                    $('#branch_required').addClass('has-error');
                } else {
                    $('#branch_required').removeClass('has-error');
                }

                $('#datamodal_branchcode').attr('disabled', false);
                $('#datamodal_branch').attr('disabled', false);
                $('#datamodal_branch').attr('required', true);
            } else {
                $('#branch_required').removeClass('has-error');
                $('#datamodal_branch').val('').change();
                $('#datamodal_branchcode').val('');
                $('#datamodal_branchcode').attr('disabled', true);
                $('#datamodal_branch').attr('disabled', true);
                $('#datamodal_branch').attr('required', false);
            }

        });
        
        $('#editAmountModal').on('shown.bs.modal', function() {
            $('#edit_amount').focus();
        });
        

        $('#dataEntryModal').on('hide.bs.modal', function(e) {
            const validationMsg = $('td#validation_message').text().trim();
            if(validationMsg !== ''){
                alert(validationMsg);
                e.preventDefault();
            }
        });
    });

</script>
